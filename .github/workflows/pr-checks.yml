name: Path Guard (Conftest)

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  path-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Compute changed files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main
          CHANGED=$(git diff --name-only origin/main...HEAD || true)
          echo "changed<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "Changed files:"
          echo "$CHANGED"

      - name: Collect PR labels (optional)
        id: labels
        shell: bash
        run: |
          jq -r '.pull_request.labels[].name' < "$GITHUB_EVENT_PATH" | tr -d '\r' > /tmp/labels.txt || true
          echo "labels<<EOF" >> "$GITHUB_OUTPUT"
          cat /tmp/labels.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "PR labels:"; cat /tmp/labels.txt || true

      - name: Create Conftest input
        shell: bash
        run: |
          python - << 'PY'
          import json, os
          files  = [f for f in os.environ.get("FILES","").splitlines()  if f.strip()]
          labels = [l for l in os.environ.get("LABELS","").splitlines() if l.strip()]
          data = {"files": files, "labels": labels, "debug": False}
          with open("input.json","w", encoding="utf-8") as fh:
              json.dump(data, fh, indent=2)
          print("----- input.json -----")
          print(json.dumps(data, indent=2))
          PY
        env:
          FILES:  ${{ steps.changed.outputs.changed }}
          LABELS: ${{ steps.labels.outputs.labels }}

      - name: Show rego + input
        shell: bash
        run: |
          echo "pwd: $(pwd)"
          echo "--- rego files ---"
          find . -maxdepth 3 -type f -name "*.rego" -print || true
          echo "--- input.json ---"
          cat input.json || true

      - name: Install Conftest
        shell: bash
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.62.0/conftest_0.62.0_Linux_x86_64.tar.gz | tar xz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Conftest verify
        shell: bash
        run: conftest verify --policy "${{ github.workspace }}/conftest-policy"

      - name: Run path guard
        shell: bash
        run: conftest test --policy "${{ github.workspace }}/conftest-policy" "${{ github.workspace }}/input.json"
