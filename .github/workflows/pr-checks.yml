name: Path Guard (Conftest)

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: read

jobs:
  path-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute changed files
        id: changed
        run: |
          set -euo pipefail
          git fetch origin main
          CHANGED=$(git diff --name-only origin/main...HEAD || true)
          echo "changed<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED"

      - name: Collect PR labels
        id: labels
        run: |
          jq -r '.pull_request.labels[].name' < "$GITHUB_EVENT_PATH" | tr -d '\r' > /tmp/labels.txt || true
          echo "labels<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/labels.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          cat /tmp/labels.txt || true

      - name: Create Conftest input
        run: |
          python - << 'PY'
          import json, os
          data = {
            "files":  [f for f in os.environ.get("FILES","").splitlines() if f.strip()],
            "labels": [l for l in os.environ.get("LABELS","").splitlines() if l.strip()],
          }
          open("input.json","w").write(json.dumps(data, indent=2))
          print(json.dumps(data, indent=2))
          PY
        env:
          FILES:  ${{ steps.changed.outputs.changed }}
          LABELS: ${{ steps.labels.outputs.labels }}

      - name: Debug workspace
        run: |
          echo "pwd: $(pwd)"
          echo "--- tree ---"
          ls -R | sed -n '1,200p'
          echo "--- rego files ---"
          find . -maxdepth 3 -type f -name "*.rego" -print || true

      - name: Install Conftest
        if: ${{ hashFiles('conftest-policy/**/*.rego') != '' }}
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.54.0/conftest_0.54.0_Linux_x86_64.tar.gz | tar xz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Conftest verify
        if: ${{ hashFiles('conftest-policy/**/*.rego') != '' }}
        run: conftest verify --policy "${{ github.workspace }}/conftest-policy"

      - name: Run path guard
        run: conftest test --policy "${{ github.workspace }}/conftest-policy" "${{ github.workspace }}/input.json"
